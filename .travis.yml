sudo: required
language: java
jdk:
- openjdk11
services:
- docker
before_install:
- openssl aes-256-cbc -K $encrypted_d702b432d88d_key -iv $encrypted_d702b432d88d_iv
  -in travis/helseci.key.enc -out travis/helseci.key -d
- git clone https://github.com/navikt/github-apps-support.git
- export PATH=`pwd`/github-apps-support/bin:$PATH
- export GH_TOKEN=$(generate-installation-token.sh `generate-jwt.sh ./travis/helseci.key
  $GITHUB_APP_ID`)
- export COMMIT_SHORT=$(git rev-parse --short HEAD)
- export ORIGINAL_COMMITTER=$(git log -1 --pretty=format:'%an <%ae>')
- echo -e "machine github.com\n  login $GH_TOKEN" > ~/.netrc
script:
- "./gradlew check jar"
- docker build --pull -t $DOCKER_IMG_NAME:$COMMIT_SHORT .
- |
  set -e
  if [ "${TRAVIS_PULL_REQUEST}" = "false" ] && [ "${TRAVIS_BRANCH}" = "master" ]; then
    echo "$DOCKER_PASSWORD" | docker login --username "$DOCKER_USERNAME" --password-stdin
    docker push $DOCKER_IMG_NAME:$COMMIT_SHORT

    git clone https://x-access-token:$GH_TOKEN@github.com/navikt/helse-iac.git

    cd helse-iac
    ./set-image.sh preprod/$APP_NAME/naiserator.yaml $DOCKER_IMG_NAME:$COMMIT_SHORT
    ./set-image.sh preprod/$APP_NAME/naiserator-sbs.yaml $DOCKER_IMG_NAME:$COMMIT_SHORT

    git config user.name team-helse[bot]
    git config user.email team-helse[bot]@users.noreply.github.com

    git add preprod/$APP_NAME/naiserator.yaml
    git add preprod/$APP_NAME/naiserator-sbs.yaml

    git commit -m "Bump $APP_NAME" -m "Caused by $TRAVIS_BUILD_WEB_URL" --author "$ORIGINAL_COMMITTER"

    git push https://x-access-token:$GH_TOKEN@github.com/navikt/helse-iac.git master

    cd ..
    fi
before_cache:
- rm -f  $HOME/.gradle/caches/modules-2/modules-2.lock
- rm -fr $HOME/.gradle/caches/*/plugin-resolution/
cache:
  directories:
  - "$HOME/.gradle/caches/"
  - "$HOME/.gradle/wrapper/"
env:
  global:
  - APP_NAME=pleiepenger-dokument
  - DOCKER_IMG_NAME=navikt/pleiepenger-dokument
  - GITHUB_APP_ID=19726
  - secure: pMN81OgW1V6cYa3En5wNZSnifFDjvhH36BlzfZZSvb1Vc6H1O9rgdxbKgLlF1czRwxdfVO80/LHyr6E96iAruiw1i4YYzcrkOXFilY6fDRRUMdQ4msFCPhEGsTEXd2tfyNNKlsYzKh8e9fJICAUManZeLf5fj0qqWwznkof2amXIB9dIVdUK7TWPo8APiMhlbQihH9mtr8OE5uMu3JJu0y+U2Due7LDUJAUc2buyt0Xc4N0RTR3oP9c2Eg5VxsSmO9R5swTzGZZ8kzVfoj20/axswcmO7iWCNpm/l9E5v4Tr2FHQcI93kJxnMS5rS55LHUYCi8APiUxdpmgQ6goUf8Lr9CQC/nF44bsPzokdLqqrNFACsnAMjP3OHliPhn/k0kfXX55GE1EM5gdLgZ0V7AKoCFhMdZG/ju7wI8YJrZoJ0glFXMNzQ/WsHaSI6bCrGyc63Q6zXDi0D79pLLJUkISSBPKwacZUrRQHJqpPDOS1obxRjfXTseM8SEDxyxF28b+w02YseaQPSuPZGMIHO6OV/WidLKs2q/r0wKkm0krvZ7to8Q1B4IQ84Ujsca1kBcyU5BfQLgLUHFy/yyL9RrJcPhtnWUYHjngOS+6Abw/BcNBLlezZOxBzhg+QlhZYxBPNcazBEeBlFylG4Tx1VsoniYjyY1/BgZXEbdJjLhQ=
  - secure: sRZmwxJ/hLTxhCTxUbgX112v6Jb9K7DUZrqFCJVizoRPqXiYYeYKn7bnweXUYYAaPWZJyEFK5nmpnRbFNfkpnTguL36xQ6FhsrDkrVCrUho+OH02PRSWG3v4NhFGzc1rFLrdQgFtrgRmwPBawYTqkzZBtF0iiNT4ntYosyqWQ+B7OcU3+ufbzzdk3Nd1Cn4EW4Yk2YyKTgeRtrlPvCU3S0tRmTw0iTvhBo3VOeqZi1duWqFzgJf2jrYN5y46UBtuMyoKzos/NRnrv0D3d7J4vddADd6a2DyT04vvIk/+Jfv1DsCApt0FgvEe33Pxf0LEgJq2TZIE88o/xZVve4NXzzODtDCdv9X4aQmsh1ZseVJsNZICe3PMtcqTDPf+sY98jyPpfon03Z/3001Ys9Y8Pk6sQKKubFD9gFb4sDioTxbNbzUfSP0dR1yu+0ogc3MSdsSEzGlQkrQfmnhBUujuTfel9A7zFU7g2nNvkSHXVqASqAm9alg934V6d46MYf3fmNpuLgXycKxUAYuC+vR0OQF6ODw+59N8acd3x3N8xNEZH/KWHgf617TiP4eXTmCVKnpb0mxro2Fv75haTFol2Amwv9n832UF/jXYYK6YSiW20wsN23hn08bPmOq5kmqxhAdXSl9FFmalmTL5138fBXFTs5VY+427+eV+5uXQkM0=
